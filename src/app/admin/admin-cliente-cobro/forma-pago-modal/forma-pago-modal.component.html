<div class="forma-pago-modal">
  <h2 mat-dialog-title>Forma de Pago</h2>

  <mat-dialog-content>
    <!-- Informaci처n del cliente -->
    <div class="info-section">
      <mat-card class="mb-3">
        <mat-card-content>
          <div class="row">
            <div class="col-md-12">
              <strong>Cliente:</strong> {{ data.cliente }}
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Documentos seleccionados -->
    <div class="documentos-section mb-4">
      <h4>Documentos Seleccionados</h4>
      <div class="table-wrapper">
        <mat-table [dataSource]="documentosConPago" class="mat-elevation-z2">
          <!-- Columnas -->
          <ng-container matColumnDef="tipo">
            <mat-header-cell *matHeaderCellDef>TIPO</mat-header-cell>
            <mat-cell *matCellDef="let doc">
              {{ doc.tipo === 'FC' ? 'FACTURA' : (doc.tipo === 'NC' ? 'NOTA CREDITO' : doc.tipo) }}
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="documento">
            <mat-header-cell *matHeaderCellDef>N째 DOCUM.</mat-header-cell>
            <mat-cell *matCellDef="let doc">{{ doc.documento }}</mat-cell>
          </ng-container>

          <ng-container matColumnDef="serie">
            <mat-header-cell *matHeaderCellDef>SERIE</mat-header-cell>
            <mat-cell *matCellDef="let doc">{{ doc.serie }}</mat-cell>
          </ng-container>

          <ng-container matColumnDef="concepto">
            <mat-header-cell *matHeaderCellDef>CONCEPTO</mat-header-cell>
            <mat-cell *matCellDef="let doc">
              <mat-form-field appearance="outline" class="concepto-field">
                <input matInput [(ngModel)]="doc.concepto" placeholder="Ingrese concepto">
              </mat-form-field>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="saldo">
            <mat-header-cell *matHeaderCellDef>SALDO</mat-header-cell>
            <mat-cell *matCellDef="let doc">${{ doc.saldo | number:'1.2-2' }}</mat-cell>
          </ng-container>

          <ng-container matColumnDef="valorAPagar">
            <mat-header-cell *matHeaderCellDef>VALOR A PAGAR</mat-header-cell>
            <mat-cell *matCellDef="let doc; let i = index">
              <mat-form-field appearance="outline">
                <input matInput type="number" [(ngModel)]="doc.valorAPagar" placeholder="0.00"
                       step="0.01" [max]="doc.saldo"
                       (change)="validarValorAPagar(i)" (input)="calcularTotalAPagar()">
              </mat-form-field>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="['tipo','documento','serie','concepto','saldo','valorAPagar']"></mat-header-row>
          <mat-row *matRowDef="let row; columns: ['tipo','documento','serie','concepto','saldo','valorAPagar']"></mat-row>
        </mat-table>
      </div>

      <mat-card class="mt-3">
        <mat-card-content>
          <div class="row">
            <div class="col-md-10 text-right">
              <strong>Total a Pagar:</strong>
            </div>
            <div class="col-md-2">
              <strong>${{ getTotalAPagar() | number:'1.2-2' }}</strong>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Formas de pago -->
    <div class="formas-pago-section">
      <h4>Formas de Pago</h4>
      <div class="table-wrapper">
        <mat-table [dataSource]="formasPago" class="mat-elevation-z2">
          <!-- Columnas -->
          <ng-container matColumnDef="formaPago">
            <mat-header-cell *matHeaderCellDef>Forma de Pago</mat-header-cell>
            <mat-cell *matCellDef="let pago">
              <mat-form-field appearance="outline">
                <mat-select [(value)]="pago.formaPago" placeholder="Seleccione...">
                  <mat-option value="">Seleccione...</mat-option>
                  <mat-option *ngFor="let opcion of formasPagoOpciones" [value]="opcion.tiptra">
                    {{ opcion.nomtra }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="entidadFinanciera">
            <mat-header-cell *matHeaderCellDef>Entidad Financiera</mat-header-cell>
            <mat-cell *matCellDef="let pago">
              <mat-form-field appearance="outline">
                <mat-select [(value)]="pago.entidadFinanciera" placeholder="Seleccione...">
                  <mat-option value="EFE">[NINGUNO]</mat-option>
                  <mat-option *ngFor="let opcion of tiposBanco" [value]="opcion.codban">
                    {{ opcion.nomban }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="fecha">
            <mat-header-cell *matHeaderCellDef>Fecha</mat-header-cell>
            <mat-cell *matCellDef="let pago">
              <mat-form-field appearance="outline">
                <input matInput type="date" [(ngModel)]="pago.fecha">
              </mat-form-field>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="numero">
            <mat-header-cell *matHeaderCellDef>N째</mat-header-cell>
            <mat-cell *matCellDef="let pago">
              <mat-form-field appearance="outline">
                <input matInput placeholder="N째" [(ngModel)]="pago.numero">
              </mat-form-field>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="valor">
            <mat-header-cell *matHeaderCellDef>Valor</mat-header-cell>
            <mat-cell *matCellDef="let pago">
              <mat-form-field appearance="outline">
                <input matInput type="number" [(ngModel)]="pago.valor" placeholder="0.00"
                       step="0.01" (change)="validarTotalFormasPago()">
              </mat-form-field>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="tipo">
            <mat-header-cell *matHeaderCellDef>Tipo</mat-header-cell>
            <mat-cell *matCellDef="let pago">
              <mat-form-field appearance="outline">
                <mat-select [(value)]="pago.tipo" placeholder="Seleccione...">
                  <mat-option value="">Seleccione...</mat-option>
                  <mat-option *ngFor="let opcion of tiposPago" [value]="opcion.codtip">
                    {{ opcion.destip }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="concepto">
            <mat-header-cell *matHeaderCellDef>Concepto</mat-header-cell>
            <mat-cell *matCellDef="let pago">
              <mat-form-field appearance="outline" class="concepto-field">
                <input matInput [(ngModel)]="pago.concepto" placeholder="Ingrese concepto">
              </mat-form-field>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="acciones">
            <mat-header-cell *matHeaderCellDef>Acciones</mat-header-cell>
            <mat-cell *matCellDef="let pago; let i = index">
              <button mat-icon-button color="warn" (click)="eliminarFormaPago(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="['formaPago','entidadFinanciera','fecha','numero','valor','tipo','concepto','acciones']"></mat-header-row>
          <mat-row *matRowDef="let row; columns: ['formaPago','entidadFinanciera','fecha','numero','valor','tipo','concepto','acciones']"></mat-row>
        </mat-table>
      </div>

      <div class="text-right mt-2">
        <button mat-stroked-button color="primary" (click)="agregarFormaPago()">+ Agregar forma de pago</button>
      </div>

      <mat-card class="mt-3">
        <mat-card-content>
          <div class="row">
            <div class="col-md-8 text-right">
              <strong>Total Formas de Pago:</strong>
            </div>
            <div class="col-md-2">
              <strong>${{ getTotalFormasPago() | number:'1.2-2' }}</strong>
            </div>
            <div class="col-md-2">
              <span [class]="getTotalFormasPago() === getTotalAPagar() ? 'text-success':'text-warning'">
                {{ getTotalFormasPago() === getTotalAPagar() 
                    ? 'Completo' 
                    : 'Pendiente: $' + (getTotalAPagar() - getTotalFormasPago() | number:'1.2-2') }}
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="onCancelar()">Cancelar</button>
    <button mat-raised-button color="primary" (click)="onProcesarPago()" [disabled]="!validarPago()">
      Procesar Pago
    </button>
  </mat-dialog-actions>
</div>
